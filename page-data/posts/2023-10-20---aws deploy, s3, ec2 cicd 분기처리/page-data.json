{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/posts/2023-10-20---aws deploy, s3, ec2 cicd 분기처리/","result":{"data":{"markdownRemark":{"id":"3be3c86e-dce8-58ca-aba9-23ee221a6935","html":"<p>진행중인 aliy 프로젝트에서 aws s3와 codedeploy를 사용해 ec2에 자동배포를 했었다.\ndev와 main 둘 다 같은 방식으로 진행을 했던터라 codedeploy 과정에서 애플리케이션을 실행하는 방식이 달랐다.</p>\n<p>이 문제를 해결하기 위해 어떤 방식이 있을지 고민했던 것들을 적어보겠다.</p>\n<h3 id=\"1-workflow에서-해결\" style=\"position:relative;\"><a href=\"#1-workflow%EC%97%90%EC%84%9C-%ED%95%B4%EA%B2%B0\" aria-label=\"1 workflow에서 해결 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. workflow에서 해결</h3>\n<p>우선적으로 생각을 했던게 브랜치가 서로 다르기 때문에 workflow 단계에서 할 수 있지 않을까? 라는 생각이었다.\n그래서 workflow에서 github contexts를 이용해 보기로 했다.</p>\n<p>github contexts로 브랜치에 따라 다른 스크립트 파일을 만들어 해결할 수 있을거라는 생각으로 시도를 했었다.</p>\n<p><a href='https://docs.github.com/en/actions/learn-github-actions/contexts'>링크</a>를 참조하여 브랜치에 따라 스크립트 파일을 만들어서 보내주는 방식으로 진행을 했었다.</p>\n<p>첫번째로 권한에러가 나왔다. workflow에서 만든 스크립트 파일에 대해 ec2에서 실행권한이 없는 문제였다.\n권한을 부여해주고 나서 다시 github action을 다시 시도해보았으나 권한 문제가 해결되지 않았다.</p>\n<p>그래서 다른 방식으로 넘어갔다.</p>\n<h3 id=\"2-appspec-단계에서-해결\" style=\"position:relative;\"><a href=\"#2-appspec-%EB%8B%A8%EA%B3%84%EC%97%90%EC%84%9C-%ED%95%B4%EA%B2%B0\" aria-label=\"2 appspec 단계에서 해결 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. appspec 단계에서 해결</h3>\n<p>appspec에는 codedeploy에서 실행되는 hook을 설정할 수 있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># 예시</span>\nversion: <span class=\"token number\">0.0</span>\nos: linux\nfiles:\n  - source: Config/config.txt\n    destination: /webapps/Config\n  - source: <span class=\"token builtin class-name\">source</span>\n    destination: /webapps/myApp\nhooks:\n  BeforeInstall:\n    - location: Scripts/UnzipResourceBundle.sh\n    - location: Scripts/UnzipDataBundle.sh\n  AfterInstall:\n    - location: Scripts/RunResourceTests.sh\n      timeout: <span class=\"token number\">180</span>\n  ApplicationStart:\n    - location: Scripts/RunFunctionalTests.sh\n      timeout: <span class=\"token number\">3600</span>\n  ValidateService:\n    - location: Scripts/MonitorService.sh\n      timeout: <span class=\"token number\">3600</span>\n      runas: codedeployuser</code></pre></div>\n<p>hook 단계에서 스크립트 파일의 경로를 설정해주니 해결할 수 있지 않을까 했지만 공식문서를 봐도 appspec에서 처리할 수 있는 방법에 대한 건 찾아볼 수 없었다.\n그래서 스크립트 파일에서 처리를 해보기로 했다.</p>\n<h3 id=\"3-스크립트-파일에서-해결\" style=\"position:relative;\"><a href=\"#3-%EC%8A%A4%ED%81%AC%EB%A6%BD%ED%8A%B8-%ED%8C%8C%EC%9D%BC%EC%97%90%EC%84%9C-%ED%95%B4%EA%B2%B0\" aria-label=\"3 스크립트 파일에서 해결 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>3. 스크립트 파일에서 해결</h3>\n<p>첫번째로 위의 appspec에서 두개의 스크립트를 넣고 스크립트 파일 내에서 실행여부를 판단하는 방식으로 접근했다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">hooks:\n<span class=\"token punctuation\">..</span>. 이전 단계\n  AfterInstall:\n    - location: 경로\n      timeout: <span class=\"token number\">180</span>\n      runas: ubuntu\n  ApplicationStart:\n    - location: 경로\n      timeout: <span class=\"token number\">180</span>\n      runas: ubuntu\n    - location: 경로\n      timeout: <span class=\"token number\">180</span>\n      runas: ubuntu</code></pre></div>\n<p>위와 같은 방식으로 진행했었다.\n애플리케이션을 시작하는 단계에서 두개의 스크립트가 실행이 되는 방식이고 dev와 main 서버에서 사용하는 env파일이 달랐기 때문에 이를 if문으로 관리를 했다.\n위의 과정이 성공적으로 이뤄졌고, if문으로 성공을 했기 때문에 하나의 스크립트 파일로 컨트롤이 가능했다. 그래서 스크립트 파일을 하나만 설정해줬다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># ...이전 과정</span>\n<span class=\"token keyword\">if</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-f</span> <span class=\"token string\">\".env.dev\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Running script for dev branch\"</span>\n  <span class=\"token comment\"># dev 애플리케이션 실행</span>\n<span class=\"token keyword\">elif</span> <span class=\"token punctuation\">[</span> <span class=\"token parameter variable\">-f</span> <span class=\"token string\">\".env.prod\"</span> <span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span> <span class=\"token keyword\">then</span>\n  <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"Running script for main branch\"</span>\n  <span class=\"token comment\"># main 애플리케이션 실행</span>\n<span class=\"token keyword\">fi</span></code></pre></div>\n<p>결국 하나의 스크립트로 해결할 수 있었다.</p>\n<h3 id=\"마치며\" style=\"position:relative;\"><a href=\"#%EB%A7%88%EC%B9%98%EB%A9%B0\" aria-label=\"마치며 permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>마치며</h3>\n<p>위 작업들을 하며 스크립트 파일을 통해 여러가지 작업을 할 수 있다는 걸 느낄 수 있었다. 물론 지금 해결한 방식보다 좋은 방식도 있을거라 생각하고 찾아보며 시도하고 적용해봐야겠다.\n1번 workflow를 사용하는 과정에서 권한문제에 관한 건 무엇때문인지 왜 그런건지 조금 더 찾아봐야 할 것 같다.</p>","fields":{"slug":"/posts/2023-10-20---aws deploy, s3, ec2 cicd 분기처리/","tagSlugs":["/tag/devops/"]},"frontmatter":{"date":"2023-10-20T12:36:37.121Z","description":"aws deploy, s3, ec2 cicd 분기처리","tags":["devops"],"title":"aws deploy, s3, ec2 cicd 분기처리","socialImage":null}}},"pageContext":{"slug":"/posts/2023-10-20---aws deploy, s3, ec2 cicd 분기처리/"}},"staticQueryHashes":["251939775","2764776372","401334301"]}