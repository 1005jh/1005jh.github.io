{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/posts/2023-11-20---외래키 변경하기/","result":{"data":{"markdownRemark":{"id":"184c9b06-b70b-512b-b7e1-74ec4dd84764","html":"<p>aliy 프로젝트 중 외래키를 변경해야 하는 일이 생겼다.</p>\n<p>각 카테고리에 대한 uniqueid를 외래키로 사용중이었는데 방식이 바뀌며 uniqueid를 사용하지 않게되어 pk로 변경을 해야했다.</p>\n<p>그래서 변경하는 과정을 포스팅을 해보겠다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">TABLE</span> 테이블 <span class=\"token punctuation\">(</span>\nid <span class=\"token keyword\">int</span> <span class=\"token operator\">NOT</span> <span class=\"token boolean\">NULL</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span> 각 카테고리 외래키<span class=\"token punctuation\">,</span>\n<span class=\"token keyword\">PRIMARY</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">KEY</span> 인덱스 <span class=\"token punctuation\">(</span>컬럼명<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">CONSTRAINT</span> 인덱스 <span class=\"token keyword\">FOREIGN</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span>mainCategoryId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">REFERENCES</span> 카테고리 테이블 <span class=\"token punctuation\">(</span>uniqueId<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ON</span> <span class=\"token keyword\">UPDATE</span> <span class=\"token keyword\">CASCADE</span>\n<span class=\"token punctuation\">)</span> <span class=\"token keyword\">ENGINE</span><span class=\"token operator\">=</span><span class=\"token keyword\">InnoDB</span> <span class=\"token keyword\">AUTO_INCREMENT</span><span class=\"token operator\">=</span><span class=\"token number\">216</span> <span class=\"token keyword\">DEFAULT</span> <span class=\"token keyword\">CHARSET</span><span class=\"token operator\">=</span>utf8mb4 <span class=\"token keyword\">COLLATE</span><span class=\"token operator\">=</span>utf8mb4_0900_ai_ci</code></pre></div>\n<p>우선 show create table 로 확인을 해보면 위처럼 나왔다.</p>\n<p>각 카테고리는 pk를 가지고 있으며 uniqueid를 가지고 있었다.\n그렇기 때문에 우선적으로 각 카테고리의 uniqueid에 대한 pk를 가지고 와야했다.</p>\n<p>그렇기 때문에 우선적으로 컬럼을 추가해 uniqueid에 맞는 pk를 가져왔다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- pk를 저장할 컬럼 생성</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> 테이블 <span class=\"token keyword\">add</span> <span class=\"token keyword\">column</span> cate_main <span class=\"token keyword\">int</span>\n<span class=\"token comment\">-- uniqueid로 pk 세팅</span>\n<span class=\"token keyword\">update</span> 테이블 <span class=\"token keyword\">join</span> mainCategory <span class=\"token keyword\">on</span> 테이블<span class=\"token punctuation\">.</span>mainCategoryId <span class=\"token operator\">=</span> mainCategory<span class=\"token punctuation\">.</span>uniqueId <span class=\"token keyword\">set</span> 테이블<span class=\"token punctuation\">.</span>cate_main <span class=\"token operator\">=</span> mainCategory<span class=\"token punctuation\">.</span>id</code></pre></div>\n<p>위 작업을 해준 후 외래키를 <code class=\"language-text\">cate_main</code>이 되게끔 해주기 위해 기존의 uniqueid에 걸려있는 외래키 인덱스를 제거해줬다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> 테이블 <span class=\"token keyword\">drop</span> <span class=\"token keyword\">foreign</span> <span class=\"token keyword\">key</span> 인덱스</code></pre></div>\n<p>위 작업에 쓰인 인덱스는\n<code class=\"language-text\">CONSTRAINT 인덱스 FOREIGN KEY (카테고리 외래키 컬럼명) REFERENCES 카테고리 테이블 (uniqueId) ON UPDATE CASCADE</code>에서의 인덱스이다.</p>\n<p>그리고 기존의 컬럼명을 다시 사용하기 위해 기존의 mainCategoryId 컬럼을 삭제해준 후 새로 만든 <code class=\"language-text\">cate_main</code>의 컬럼명을 변경해줬다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token comment\">-- 기존 uniqueid를 가지고 있는 외래키 삭제</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> 테이블\n<span class=\"token keyword\">DROP</span> <span class=\"token keyword\">COLUMN</span> mainCategoryId<span class=\"token punctuation\">;</span>\n<span class=\"token comment\">-- cate_main 컬럼명 변경</span>\n<span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> 테이블 change <span class=\"token keyword\">column</span> cate_main mainCategoryId <span class=\"token keyword\">int</span> <span class=\"token operator\">not</span> <span class=\"token boolean\">null</span></code></pre></div>\n<p>위 작업이 끝나면 기존의 uniqueid를 가지고 있던 mainCategroyId는 사라지고, pk를 저장한 cate_main컬럼이 mainCategroyId가 되어있다.\n마지막으로 삭제를 한 외래키의 인덱스를 다시 걸어주면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">alter</span> <span class=\"token keyword\">table</span> 테이블\n<span class=\"token keyword\">add</span> <span class=\"token keyword\">constraint</span> 인덱스\n<span class=\"token keyword\">foreign</span> <span class=\"token keyword\">key</span> <span class=\"token punctuation\">(</span>mainCategoryId<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">references</span> <span class=\"token string\">'mainCategory'</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">on</span> <span class=\"token keyword\">update</span> <span class=\"token keyword\">cascade</span></code></pre></div>\n<p>위의 작업이 성공했다면 mainCategoryId에 대한 값이 uniqueId -> pk로 변경이 완료된다.</p>\n<p>비즈니스 로직 변경도 필요하다.</p>\n<p>참고</p>\n<p><a href=\"https://dev.mysql.com/doc/refman/8.0/en/create-table-foreign-keys.html\"><a href=\"https://dev.mysql.com/doc/refman/8.0/en/create-table-foreign-keys.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://dev.mysql.com/doc/refman/8.0/en/create-table-foreign-keys.html</a></a></p>","fields":{"slug":"/posts/2023-11-20---외래키 변경하기/","tagSlugs":["/tag/mysql/"]},"frontmatter":{"date":"2023-11-20T12:36:37.121Z","description":"외래키 변경하기","tags":["mysql"],"title":"외래키 변경하기","socialImage":null}}},"pageContext":{"slug":"/posts/2023-11-20---외래키 변경하기/"}},"staticQueryHashes":["251939775","2764776372","401334301"]}