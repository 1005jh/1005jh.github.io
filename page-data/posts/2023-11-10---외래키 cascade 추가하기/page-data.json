{"componentChunkName":"component---src-templates-post-template-post-template-tsx","path":"/posts/2023-11-10---외래키 cascade 추가하기/","result":{"data":{"markdownRemark":{"id":"810d1403-6eb2-54c0-ae7a-9f33a11f54a8","html":"<p><code class=\"language-text\">cascade</code>는 mysql의 외래키 옵션 중 하나로 무결성을 유지하며 연결된 레코드의 작업을 자동으로 해주는 옵션이다.\n부모에서 <code class=\"language-text\">update</code>나 <code class=\"language-text\">delete</code>작업이 자식에게도 반영이 된다.</p>\n<p>이 옵션을 설정해주지 않는다면 부모에서의 <code class=\"language-text\">update</code>나 <code class=\"language-text\">delete</code> 작업에서 에러를 마주할 수 있다. 어떤 에러가 발생했고 어떻게 해결했는지 포스팅해보겠다.</p>\n<p>aliy 프로젝트를 진행하며 카테고리를 매핑하는 테이블을 만들었었다.</p>\n<p>그 과정에서 uniqueId를 외래키로 사용했었는데 이 과정에서 <code class=\"language-text\">cascade</code>옵션을 빠트려 문제가 발생했었다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Cannot delete or update a parent row: a foreign key constraint fails (매핑테이블, CONSTRAINT ... FOREIGN KEY (mainCategoryId) REFERENCES 부모테이블 (uniqueId))</code></pre></div>\n<p>카테고리가 변경됨에 따라 카테고리의 uniqueId를 수정하며 생긴 이슈였다. <code class=\"language-text\">cascade</code>옵션이 없었기 때문에 수정하는 과정에서 자식 테이블에 적용이 되지 않았고, 외래키 제약조건에 실패했다며 위와 같은 에러를 뱉었다.</p>\n<p>그래서 <code class=\"language-text\">show create table 테이블명</code>을 이용해 테이블을 확인해봤다.</p>\n<div class=\"gatsby-highlight\" data-language=\"mysql\"><pre class=\"language-mysql\"><code class=\"language-mysql\">CREATE TABLE 테이블 (\nid int NOT NULL AUTO_INCREMENT,\n... 각 카테고리 외래키,\nPRIMARY KEY (id),\nKEY 인덱스 (외래키),\nKEY 인덱스 (외래키),\nKEY 인덱스 (외래키),\nKEY 인덱스 (외래키),\n...\nCONSTRAINT 인덱스 FOREIGN KEY (외래키) REFERENCES 카테고리 테이블 (uniqueId),\n) ENGINE=InnoDB AUTO_INCREMENT=70 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci</code></pre></div>\n<p>들어가야 할 <code class=\"language-text\">cascade</code>옵션이 빠져 있는 걸 확인 할 수 있었다.</p>\n<p>그러면 <code class=\"language-text\">cascade</code>옵션을 다시 추가하려면 어떻게 해야할까?</p>\n<p><a href=\"https://dev.mysql.com/doc/refman/8.0/en/create-table-foreign-keys.html#foreign-key-adding\">mysql 홈페이지</a>에서 살펴보면 외래키를 추가하기 위해서는 외래키가 참조하는 컬럼에 인덱스를 생성해야 한다고 나와있다.</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">Adding Foreign Key Constraints\nYou can add a foreign key constraint to an existing table using the following ALTER TABLE syntax:\n\nALTER TABLE tbl_name\n    ADD [CONSTRAINT [symbol]] FOREIGN KEY\n    [index_name] (col_name, ...)\n    REFERENCES tbl_name (col_name,...)\n    [ON DELETE reference_option]\n    [ON UPDATE reference_option]\nThe foreign key can be self referential (referring to the same table). When you add a foreign key constraint to a table using ALTER TABLE, remember to first create an index on the column(s) referenced by the foreign key.</code></pre></div>\n<p>우선 인덱스가 걸려있으니 기존 인덱스를 삭제하고 다시 걸어주며 걸어줄 때 <code class=\"language-text\">cascade</code>옵션을 넣기로 했다.</p>\n<p>우선 <code class=\"language-text\">casecade</code>옵션이 빠진 외래키에서 인덱스를 제거해준다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> tbl_name <span class=\"token keyword\">DROP</span> <span class=\"token keyword\">FOREIGN</span> <span class=\"token keyword\">KEY</span> fk_symbol<span class=\"token punctuation\">;</span>\n예시<span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> 테이블명 <span class=\"token keyword\">DROP</span> <span class=\"token keyword\">FOREIGN</span> <span class=\"token keyword\">KEY</span> 인덱스<span class=\"token punctuation\">;</span></code></pre></div>\n<p>위의 작업이 성공했으면 다시 인덱스를 걸어준다. 기존의 삭제한 인덱스를 다시 걸어줄건데 옵션을 넣어주면 된다.</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> tbl_name\n    <span class=\"token keyword\">ADD</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">CONSTRAINT</span> <span class=\"token punctuation\">[</span>symbol<span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token keyword\">FOREIGN</span> <span class=\"token keyword\">KEY</span>\n    <span class=\"token punctuation\">[</span>index_name<span class=\"token punctuation\">]</span> <span class=\"token punctuation\">(</span>col_name<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">REFERENCES</span> tbl_name <span class=\"token punctuation\">(</span>col_name<span class=\"token punctuation\">,</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">[</span><span class=\"token keyword\">ON</span> <span class=\"token keyword\">DELETE</span> reference_option<span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">[</span><span class=\"token keyword\">ON</span> <span class=\"token keyword\">UPDATE</span> reference_option<span class=\"token punctuation\">]</span>\n예시<span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">ALTER</span> <span class=\"token keyword\">TABLE</span> 테이블명\n<span class=\"token keyword\">ADD</span> <span class=\"token keyword\">CONSTRAINT</span> 인덱스\n<span class=\"token keyword\">FOREIGN</span> <span class=\"token keyword\">KEY</span> <span class=\"token punctuation\">(</span>컬럼명<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">REFERENCES</span> 부모테이블 <span class=\"token punctuation\">(</span>uniqueId<span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">ON</span> <span class=\"token keyword\">DELETE</span> <span class=\"token keyword\">CASCADE</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">ON</span> <span class=\"token keyword\">UPDATE</span> <span class=\"token keyword\">CASCADE</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>위와 같은 방법으로 넣어주고 에러를 해결할 수 있다.</p>","fields":{"slug":"/posts/2023-11-10---외래키 cascade 추가하기/","tagSlugs":["/tag/mysql/"]},"frontmatter":{"date":"2023-11-10T12:36:37.121Z","description":"외래키 cascade 추가하기","tags":["mysql"],"title":"외래키 cascade 추가하기","socialImage":null}}},"pageContext":{"slug":"/posts/2023-11-10---외래키 cascade 추가하기/"}},"staticQueryHashes":["251939775","2764776372","401334301"]}